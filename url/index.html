<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      // Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDIHiX0ajmEbtkm1yZYzD2fIjt5RhH-X50",
        authDomain: "nolonglinks.firebaseapp.com",
        projectId: "nolonglinks",
        storageBucket: "nolonglinks.firebasestorage.app",
        messagingSenderId: "914293239640",
        appId: "1:914293239640:web:c6c2ded71a3bc698fd3f2d"
      };

      // Initialize
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function handleRedirect() {
        const params = new URLSearchParams(window.location.search);
        const destination = params.get('q');

        if (!destination) {
           document.body.innerHTML = "<h1>Error: No URL provided.</h1><p>Usage: <code>l.veerbajaj.com/url?q=https://example.com</code></p>";
           return;
        }

        // --- TRACKING START ---
        try {
            // Fetch basic IP/Location data with a timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 1500); // 1.5s max wait

            let geoData = {};
            try {
                const response = await fetch('https://ipapi.co/json/', { signal: controller.signal });
                geoData = await response.json();
            } catch (e) {
                console.log("Geo fetch skipped/failed");
            } finally {
                clearTimeout(timeoutId);
            }

            // Log to a dedicated 'quick_redirects' collection
            await addDoc(collection(db, "quick_redirects"), {
                timestamp: new Date().toISOString(),
                destination: destination,
                ip: geoData.ip || 'Unknown',
                city: geoData.city || 'Unknown',
                country: geoData.country_name || 'Unknown',
                countryCode: geoData.country_code || 'UN',
                userAgent: navigator.userAgent,
                referrer: document.referrer || 'Direct',
                device: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                screen: `${window.screen.width}x${window.screen.height}`
            });
        } catch (trackError) {
            console.error("Analytics error:", trackError);
            // We do NOT stop the redirect if analytics fail
        }
        // --- TRACKING END ---

        // Perform the redirect
        window.location.replace(destination);
      }

      handleRedirect();
    </script>
  </head>
  <body>
    <p>Redirecting...</p>
  </body>
</html>
