<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      // Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDIHiX0ajmEbtkm1yZYzD2fIjt5RhH-X50",
        authDomain: "nolonglinks.firebaseapp.com",
        projectId: "nolonglinks",
        storageBucket: "nolonglinks.firebasestorage.app",
        messagingSenderId: "914293239640",
        appId: "1:914293239640:web:c6c2ded71a3bc698fd3f2d"
      };

      // Initialize
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Path Config: Set to 1 if hosting at username.github.io/repo/
      // Set to 0 if hosting at a custom domain or username.github.io/
      const PATH_SEGMENTS_TO_SKIP = 0; 

      async function handleRedirect() {
        const location = window.location;
        const pathSegments = location.pathname.split('/').filter(p => p.length > 0);
        
        // Get the slug (back half)
        // If PATH_SEGMENTS_TO_SKIP is 0, we take the first segment
        const slug = pathSegments[PATH_SEGMENTS_TO_SKIP];

        if (!slug) {
          // If no slug provided, go to the homepage (index.html)
           window.location.replace(
            location.protocol + "//" + location.hostname + (location.port ? ":" + location.port : "") + "/"
          );
          return;
        }

        try {
          const docRef = doc(db, "links", slug);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.url) {
              window.location.replace(data.url);
            } else {
              document.body.innerHTML = "<h1>Error: Link found but no URL defined.</h1>";
            }
          } else {
            document.body.innerHTML = "<h1>404: Link not found</h1><p>Check your URL or create a new one at <a href='/'>home</a>.</p>";
          }
        } catch (error) {
          console.error("Error getting document:", error);
          document.body.innerHTML = "<h1>Error fetching link.</h1>";
        }
      }

      handleRedirect();
    </script>
  </head>
  <body>
    <p>Redirecting...</p>
  </body>
</html>
