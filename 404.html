<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Redirecting...</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      // Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDIHiX0ajmEbtkm1yZYzD2fIjt5RhH-X50",
        authDomain: "nolonglinks.firebaseapp.com",
        projectId: "nolonglinks",
        storageBucket: "nolonglinks.firebasestorage.app",
        messagingSenderId: "914293239640",
        appId: "1:914293239640:web:c6c2ded71a3bc698fd3f2d"
      };

      // Initialize
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Path Config
      const PATH_SEGMENTS_TO_SKIP = 0; 

      async function handleRedirect() {
        const location = window.location;
        const pathSegments = location.pathname.split('/').filter(p => p.length > 0);
        const slug = pathSegments[PATH_SEGMENTS_TO_SKIP];

        if (!slug) {
           window.location.replace(
            location.protocol + "//" + location.hostname + (location.port ? ":" + location.port : "") + "/"
          );
          return;
        }

        try {
          const docRef = doc(db, "links", slug);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            
            if (data.url) {
              // --- TRACKING START ---
              try {
                // Fetch basic IP/Location data
                // setting a timeout so analytics don't hang the redirect indefinitely
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1500); // 1.5s max wait

                let geoData = {};
                try {
                    const response = await fetch('https://ipapi.co/json/', { signal: controller.signal });
                    geoData = await response.json();
                } catch (e) {
                    console.log("Geo fetch skipped/failed");
                } finally {
                    clearTimeout(timeoutId);
                }

                // Log the visit to Firestore subcollection 'visits'
                await addDoc(collection(db, "links", slug, "visits"), {
                    timestamp: new Date().toISOString(),
                    ip: geoData.ip || 'Unknown',
                    city: geoData.city || 'Unknown',
                    country: geoData.country_name || 'Unknown',
                    countryCode: geoData.country_code || 'UN',
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'Direct',
                    device: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                    screen: `${window.screen.width}x${window.screen.height}`
                });
              } catch (trackError) {
                console.error("Analytics error:", trackError);
                // We do NOT stop the redirect if analytics fail
              }
              // --- TRACKING END ---

              window.location.replace(data.url);
            } else {
              document.body.innerHTML = "<h1>Error: Link found but no URL defined.</h1>";
            }
          } else {
            document.body.innerHTML = "<h1>404: Link not found</h1><p>Check your URL or create a new one at <a href='/'>home</a>.</p>";
          }
        } catch (error) {
          console.error("Error getting document:", error);
          document.body.innerHTML = "<h1>Error fetching link.</h1>";
        }
      }

      handleRedirect();
    </script>
  </head>
  <body>
    <p>Redirecting...</p>
  </body>
</html>
