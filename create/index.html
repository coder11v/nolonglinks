<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Creating Link...</title>
    <style>
      :root {
        --bg-primary: #0a0a0a;
        --text-primary: #ffffff;
        --accent: #6366f1;
        --success: #10b981;
        --error: #ef4444;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      .status-card {
        background: #141414;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 24px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      .loader {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(99, 102, 241, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      .icon { font-size: 48px; margin-bottom: 16px; display: block; }
      h1 { font-size: 20px; margin-bottom: 10px; }
      p { color: #a0a0a0; font-size: 14px; word-break: break-all; }
      
      .link-box {
        margin-top: 20px;
        background: rgba(255,255,255,0.05);
        padding: 15px;
        border-radius: 8px;
        font-family: monospace;
        color: var(--accent);
        cursor: pointer;
      }

      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>

    <div id="loading" class="status-card">
      <div class="loader"></div>
      <h1>Processing...</h1>
      <p>Creating your short link</p>
    </div>

    <div id="success" class="status-card" style="display: none;">
      <span class="icon">✨</span>
      <h1>Link Created!</h1>
      <div class="link-box" id="result-link" onclick="copyLink()"></div>
      <p style="margin-top: 15px; font-size: 12px;">Click box to copy</p>
    </div>

    <div id="error" class="status-card" style="display: none; border-color: var(--error);">
      <span class="icon">⚠️</span>
      <h1 style="color: var(--error)">Error</h1>
      <p id="error-msg"></p>
      <a href="/" style="display: inline-block; margin-top: 20px; color: white; text-decoration: none; border: 1px solid white; padding: 8px 16px; border-radius: 8px;">Go Home</a>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDIHiX0ajmEbtkm1yZYzD2fIjt5RhH-X50",
        authDomain: "nolonglinks.firebaseapp.com",
        projectId: "nolonglinks",
        storageBucket: "nolonglinks.firebasestorage.app",
        messagingSenderId: "914293239640",
        appId: "1:914293239640:web:c6c2ded71a3bc698fd3f2d"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function init() {
        const params = new URLSearchParams(window.location.search);
        const url = params.get('url');
        let slug = params.get('slug');

        // Validation
        if (!url) {
          showError("Missing 'url' parameter.");
          return;
        }

        try {
          // Auto-generate slug if missing
          if (!slug) {
            slug = Math.random().toString(36).substring(2, 8);
          }

          // Validate slug format
          if (!/^[a-zA-Z0-9-_]+$/.test(slug)) {
            showError("Slug contains invalid characters. Use letters, numbers, hyphens, or underscores.");
            return;
          }

          const docRef = doc(db, "links", slug);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
             showError(`The slug '${slug}' is already taken.`);
             return;
          }

          // Create the link
          await setDoc(docRef, {
            url: url,
            createdAt: new Date().toISOString()
          });

          showSuccess(slug);

        } catch (err) {
          console.error(err);
          showError(err.message);
        }
      }

      function showSuccess(slug) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('success').style.display = 'block';
        const fullUrl = window.location.origin + "/" + slug;
        document.getElementById('result-link').textContent = fullUrl;
      }

      function showError(msg) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error-msg').textContent = msg;
      }

      // Expose copy function globally
      window.copyLink = async () => {
        const text = document.getElementById('result-link').textContent;
        try {
          await navigator.clipboard.writeText(text);
          alert("Copied to clipboard!");
        } catch (e) {
          prompt("Copy this link:", text);
        }
      };

      init();
    </script>
  </body>
</html>
